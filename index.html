<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í”„ë¡œíŒŒì¼ì»¤ë¨¸ìŠ¤ ìë™ê²¬ì </title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6fa;margin:0;padding:20px;}
.container{max-width:1100px;margin:auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.08);}
h2{margin-top:30px;}
.size-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;}
.size-btn{padding:10px;border:none;border-radius:8px;background:#e8ecf4;cursor:pointer;}
.size-btn.active{background:#2c3e70;color:#fff;}
input,select{padding:8px;margin:5px 0;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box;}
button{padding:10px 15px;border:none;border-radius:6px;background:#2c3e70;color:#fff;cursor:pointer;}
.cart table{width:100%;border-collapse:collapse;margin-top:15px;}
.cart th,.cart td{border:1px solid #ddd;padding:6px;text-align:center;}
.cart th{background:#f0f2f7;}
.total{text-align:right;font-weight:bold;margin-top:10px;font-size:18px;}
</style>
</head>

<body>
<div class="container">

<h2>1ï¸âƒ£ ê·œê²© ì„ íƒ</h2>
<div class="size-grid" id="sizeGrid"></div>

<h2>2ï¸âƒ£ ê¸¸ì´ ë° ìˆ˜ëŸ‰</h2>
<select id="color">
<option value="silver">ì‹¤ë²„</option>
<option value="black">ë¸”ë™</option>
</select>
<input type="number" id="length" placeholder="ê¸¸ì´(mm)" min="50">
<input type="number" id="qty" placeholder="ìˆ˜ëŸ‰" min="1">
<div id="price">0 ì›</div>

<h2>3ï¸âƒ£ ê°€ê³µ ì˜µì…˜</h2>
íƒ­ <input type="number" id="tapQty" value="0" min="0">
í™€ <input type="number" id="holeQty" value="0" min="0">
ì¹´ìš´í„° <input type="number" id="counterQty" value="0" min="0">
<br><br>
<button onclick="addToCart()">ì œí’ˆë‹´ê¸°</button>

<div class="cart">
<h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>
<table>
<thead>
<tr>
<th>ê·œê²©</th><th>ìƒ‰ìƒ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th>
<th>ê°€ê³µ</th><th>ê¸ˆì•¡</th><th>ì‚­ì œ</th>
</tr>
</thead>
<tbody id="cartBody"></tbody>
</table>
<div class="total">ì´ í•©ê³„: <span id="grandTotal">0</span> ì›</div>
</div>

<h2>4ï¸âƒ£ ê³ ê° ì •ë³´</h2>
<input type="text" id="custName" placeholder="ê³ ê°ëª…">
<input type="text" id="custPhone" placeholder="ì—°ë½ì²˜">
<input type="email" id="custEmail" placeholder="ì´ë©”ì¼">
<br><br>
<button onclick="submitQuote()">ê²¬ì  ìš”ì²­</button>

</div>

<script>

// ğŸ” Supabase ì—°ê²°
const supabase = window.supabase.createClient(
  "https://ritzqnjgivmrtysulzil.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpdHpxbmpnaXZtcnR5c3VsemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2MjMsImV4cCI6MjA4NzU1NjYyM30.oTeXacJlkMXKw1G4IRWUa3G2DM1wPvFl-9rzf5IdsxY"
);

// ë‹¨ê°€í‘œ
const prices = {
  2020:{silver:3900,black:6000},
  2040:{silver:6900,black:9000},
  3030:{silver:8900,black:11000},
  3060:{silver:14000,black:18000},
  4040:{silver:16000,black:19000},
  4080:{silver:28000,black:30000}
};

let selectedSize = "2020";

function createSizeButtons(){
  const grid = document.getElementById("sizeGrid");
  Object.keys(prices).forEach(size=>{
    const btn = document.createElement("button");
    btn.innerText = size;
    btn.className = "size-btn";
    btn.onclick = function(){
      document.querySelectorAll(".size-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      selectedSize = size;
      updatePrice();
    };
    grid.appendChild(btn);
  });
  document.querySelector(".size-btn").classList.add("active");
}

function calculateLine(size,color,length,qty,tap,hole,counter){
  if(length < 50) length = 50;
  const unit100 = Math.ceil(length/100);
  const base100 = prices[size][color] / 10;
  let total = unit100 * base100 * qty;
  total += 300*tap + 400*hole + 1000*counter;
  return {total,calculatedLength:unit100*100};
}

function updatePrice(){
  const color = document.getElementById("color").value;
  const length = parseInt(document.getElementById("length").value)||0;
  const qty = parseInt(document.getElementById("qty").value)||0;
  const tap = parseInt(document.getElementById("tapQty").value)||0;
  const hole = parseInt(document.getElementById("holeQty").value)||0;
  const counter = parseInt(document.getElementById("counterQty").value)||0;
  const result = calculateLine(selectedSize,color,length,qty,tap,hole,counter);
  document.getElementById("price").textContent = result.total.toLocaleString()+" ì›";
}

document.addEventListener("input",updatePrice);

function addToCart(){
  const color = document.getElementById("color").value;
  const length = parseInt(document.getElementById("length").value)||0;
  const qty = parseInt(document.getElementById("qty").value)||0;
  const tap = parseInt(document.getElementById("tapQty").value)||0;
  const hole = parseInt(document.getElementById("holeQty").value)||0;
  const counter = parseInt(document.getElementById("counterQty").value)||0;
  const result = calculateLine(selectedSize,color,length,qty,tap,hole,counter);

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${selectedSize}</td>
    <td>${color}</td>
    <td>${result.calculatedLength}</td>
    <td>${qty}</td>
    <td>íƒ­:${tap} í™€:${hole} ì¹´ìš´í„°:${counter}</td>
    <td class="linePrice">${result.total.toLocaleString()}</td>
    <td><button onclick="this.closest('tr').remove();updateGrand();">X</button></td>
  `;
  document.getElementById("cartBody").appendChild(row);
  updateGrand();
}

function updateGrand(){
  let sum=0;
  document.querySelectorAll(".linePrice").forEach(cell=>{
    sum+=parseInt(cell.textContent.replace(/,/g,''))||0;
  });
  document.getElementById("grandTotal").textContent=sum.toLocaleString();
}

async function submitQuote(){
  const name=document.getElementById("custName").value;
  const phone=document.getElementById("custPhone").value;
  const email=document.getElementById("custEmail").value;
  if(!name||!phone||!email){alert("ì •ë³´ ì…ë ¥í•˜ì„¸ìš”");return;}

  const total=parseInt(document.getElementById("grandTotal").textContent.replace(/,/g,''))||0;
  const orderNo="BD-"+Date.now();

  await supabase.from("quotes").insert([{order_no:orderNo,name,phone,email,total,status:"ì ‘ìˆ˜"}]);

  await fetch("/api/send-email",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name,phone,email,total,orderNo})});

  await fetch("/api/customer",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name,email,total,orderNo})});

  alert("ì ‘ìˆ˜ ì™„ë£Œ! ì£¼ë¬¸ë²ˆí˜¸: "+orderNo);
}

createSizeButtons();
updatePrice();

</script>
</body>
</html>
