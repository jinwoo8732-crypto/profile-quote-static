<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>프로파일 자동견적</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f6f7fb;}
.header{background:#1e2a45;color:#fff;padding:20px;text-align:center;font-weight:bold;font-size:20px;}
.section{background:#fff;padding:20px;margin-bottom:10px;}
.size-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;}
.size-card{padding:15px;background:#eef1f7;border-radius:10px;text-align:center;font-weight:600;cursor:pointer;}
.size-card.active{background:#1e2a45;color:#fff;}
input,select{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ccc;}
.price-box{font-size:18px;font-weight:bold;margin-top:10px;}
.cart-item{background:#f1f3f9;padding:10px;border-radius:8px;margin-bottom:6px;font-size:14px;}
.fixed-bar{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:1px solid #ddd;padding:10px;display:flex;gap:10px;}
.fixed-bar button{flex:1;padding:15px;border:none;border-radius:8px;font-weight:bold;}
.btn-primary{background:#1e2a45;color:#fff;}
.btn-outline{background:#fff;border:2px solid #1e2a45;color:#1e2a45;}
.footer-space{height:100px;}
</style>
</head>

<body>

<div class="header">프로파일 자동견적</div>

<div class="section">
<h3>규격 선택</h3>
<div id="sizeGrid" class="size-grid"></div>
</div>

<div class="section">
<h3>길이 / 수량</h3>
<select id="color">
<option value="silver">실버</option>
<option value="black">블랙</option>
</select>
<input type="number" id="length" placeholder="길이(mm)" min="50">
<input type="number" id="qty" placeholder="수량">
<div class="price-box" id="price">0 원</div>
</div>

<div class="section">
<h3>가공 옵션</h3>
탭 <input type="number" id="tapQty" value="0">
홀 <input type="number" id="holeQty" value="0">
카운터 <input type="number" id="counterQty" value="0">
<button style="margin-top:10px;width:100%" onclick="addToCart()">장바구니 담기</button>
</div>

<div class="section">
<h3>장바구니</h3>
<div id="cartList"></div>
<div class="price-box">총 합계: <span id="grandTotal">0</span> 원</div>
</div>

<div class="section">
<h3>고객 정보</h3>
<input type="text" id="custName" placeholder="고객명">
<input type="text" id="custPhone" placeholder="연락처">
<input type="email" id="custEmail" placeholder="이메일">
</div>

<div class="footer-space"></div>

<div class="fixed-bar">
<button class="btn-outline" onclick="downloadPDF()">PDF</button>
<button class="btn-primary" onclick="submitQuote()">견적요청</button>
</div>

<script>

/* Supabase 안전 생성 */
if(!window._sb){
window._sb = window.supabase.createClient(
"https://ritzqnjgivmrtysulzil.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpdHpxbmpnaXZtcnR5c3VsemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2MjMsImV4cCI6MjA4NzU1NjYyM30.oTeXacJlkMXKw1G4IRWUa3G2DM1wPvFl-9rzf5IdsxY"
);
}

/* 단가 */
const prices={
2020:{silver:3900,black:6000},
2040:{silver:6900,black:9000},
3030:{silver:8900,black:11000},
3060:{silver:14000,black:18000},
4040:{silver:16000,black:19000},
4080:{silver:28000,black:30000}
};

let selectedSize="2020";

/* 규격 버튼 */
function createSizeButtons(){
const grid=document.getElementById("sizeGrid");
Object.keys(prices).forEach(size=>{
const card=document.createElement("div");
card.className="size-card";
card.innerText=size;
card.onclick=function(){
document.querySelectorAll(".size-card").forEach(c=>c.classList.remove("active"));
card.classList.add("active");
selectedSize=size;
updatePrice();
};
grid.appendChild(card);
});
document.querySelector(".size-card").classList.add("active");
}

/* 계산 */
function calculateLine(size,color,length,qty,tap,hole,counter){
if(length<50) length=50;
const unit100=Math.ceil(length/100);
const base100=prices[size][color]/10;
let total=unit100*base100*qty;
total+=300*tap+400*hole+1000*counter;
return total;
}

function updatePrice(){
const color=document.getElementById("color").value;
const length=parseInt(document.getElementById("length").value)||0;
const qty=parseInt(document.getElementById("qty").value)||0;
const tap=parseInt(document.getElementById("tapQty").value)||0;
const hole=parseInt(document.getElementById("holeQty").value)||0;
const counter=parseInt(document.getElementById("counterQty").value)||0;
const total=calculateLine(selectedSize,color,length,qty,tap,hole,counter);
document.getElementById("price").innerText=total.toLocaleString()+" 원";
}

document.addEventListener("input",updatePrice);

/* 장바구니 */
function addToCart(){
const total=parseInt(document.getElementById("price").innerText.replace(/,/g,''))||0;
const div=document.createElement("div");
div.className="cart-item";
div.innerText=selectedSize+" / "+total.toLocaleString()+" 원";
document.getElementById("cartList").appendChild(div);
updateGrand();
}

function updateGrand(){
let sum=0;
document.querySelectorAll(".cart-item").forEach(item=>{
const num=item.innerText.match(/\d[\d,]*/);
if(num) sum+=parseInt(num[0].replace(/,/g,''));
});
document.getElementById("grandTotal").innerText=sum.toLocaleString();
}

/* PDF */
function downloadPDF(){
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
doc.text("Profile Quotation",20,20);
doc.save("quotation.pdf");
}

/* 제출 */
async function submitQuote(){
const name=document.getElementById("custName").value;
const phone=document.getElementById("custPhone").value;
const email=document.getElementById("custEmail").value;
const total=parseInt(document.getElementById("grandTotal").innerText.replace(/,/g,''))||0;
const orderNo="BD-"+Date.now();

await window._sb.from("quotes").insert([{order_no:orderNo,name,phone,email,total,status:"접수"}]);

await fetch("/api/send-email",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({name,phone,email,total,orderNo})
});

alert("접수 완료!");
}

createSizeButtons();
updatePrice();

</script>
</body>
</html>






