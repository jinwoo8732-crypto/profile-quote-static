<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>프로파일 자동견적</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f6f7fb;}
.header{background:#1e2a45;color:#fff;padding:20px;text-align:center;font-size:20px;font-weight:bold;}
.section{background:#fff;padding:20px;margin-bottom:10px;}
.size-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;}
.size-card{padding:10px;background:#eef1f7;border-radius:10px;text-align:center;cursor:pointer;}
.size-card.active{background:#1e2a45;color:#fff;}
.size-card img{width:100%;max-height:80px;object-fit:contain;margin-bottom:6px;}
input,select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc;}
.total-box{font-weight:bold;font-size:18px;margin-top:10px;}
.cart-item{background:#f1f3f9;padding:10px;border-radius:8px;margin-bottom:8px;}
button{padding:8px 12px;margin-top:8px;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>

<body>

<div class="header">프로파일 자동견적</div>

<div class="section">
<h3>1. 규격 선택</h3>
<div id="sizeGrid" class="size-grid"></div>
</div>

<div class="section">
<h3>2. 길이 / 수량</h3>
<select id="color">
<option value="silver">실버</option>
<option value="black">블랙</option>
</select>
<input type="number" id="length" placeholder="길이(mm)" min="50">
<input type="number" id="qty" placeholder="수량" min="1">
<div class="total-box" id="price">0 원</div>
</div>

<div class="section">
<h3>3. 가공 옵션</h3>
한쪽탭 <input type="number" id="tapOneQty" value="0">
양쪽탭 <input type="number" id="tapTwoQty" value="0">
홀 <input type="number" id="holeQty" value="0">
카운터 <input type="number" id="counterQty" value="0">
<button onclick="addToCart()">장바구니 담기</button>
</div>

<div class="section">
<h3>장바구니</h3>
<div id="cartList"></div>
<div class="total-box">총 합계: <span id="grandTotal">0</span> 원</div>
<button onclick="downloadPDF()">PDF 다운로드</button>
<button onclick="submitQuote()">견적 요청</button>
</div>

<script>

const supabase = window.supabase.createClient(
"https://ritzqnjgivmrtysulzil.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpdHpxbmpnaXZtcnR5c3VsemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2MjMsImV4cCI6MjA4NzU1NjYyM30.oTeXacJlkMXKw1G4IRWUa3G2DM1wPvFl-9rzf5IdsxY"
);

const prices={
2020:{silver:3900,black:6000},
2040:{silver:6900,black:9000},
3030:{silver:8900,black:11000}
};

let selectedSize="2020";

/* 규격 생성 */
function createSizeButtons(){
const grid=document.getElementById("sizeGrid");
grid.innerHTML="";
Object.keys(prices).forEach(size=>{
const card=document.createElement("div");
card.className="size-card";
card.innerHTML=`<img src="/images/${size}_silver.png"><div>${size}</div>`;
card.onclick=function(){
document.querySelectorAll(".size-card").forEach(c=>c.classList.remove("active"));
card.classList.add("active");
selectedSize=size;
updatePrice();
};
grid.appendChild(card);
});
document.querySelector(".size-card").classList.add("active");
}

function calculateLine(size,color,length,qty,tapOne,tapTwo,hole,counter){
if(length<50) return 0;
const unit100=Math.ceil(length/100);
const base100=prices[size][color]/10;
let total=unit100*base100*qty;
total+=300*tapOne+600*tapTwo+400*hole+1000*counter;
return total;
}

function updatePrice(){
const color=document.getElementById("color").value;
const length=parseInt(document.getElementById("length").value)||0;
const qty=parseInt(document.getElementById("qty").value)||0;
const tapOne=parseInt(document.getElementById("tapOneQty").value)||0;
const tapTwo=parseInt(document.getElementById("tapTwoQty").value)||0;
const hole=parseInt(document.getElementById("holeQty").value)||0;
const counter=parseInt(document.getElementById("counterQty").value)||0;
const total=calculateLine(selectedSize,color,length,qty,tapOne,tapTwo,hole,counter);
document.getElementById("price").innerText=total.toLocaleString()+" 원";
}

document.addEventListener("input",updatePrice);

function addToCart(){
const color=document.getElementById("color").value;
const length=document.getElementById("length").value;
const qty=document.getElementById("qty").value;
if(!length||!qty){alert("길이/수량 입력");return;}
const total=document.getElementById("price").innerText;
const div=document.createElement("div");
div.className="cart-item";
div.innerHTML=`${selectedSize} (${color}) / ${length}mm / ${qty}개 / ${total}
<br><button onclick="this.parentElement.remove();updateGrand();">삭제</button>`;
document.getElementById("cartList").appendChild(div);
updateGrand();
}

function updateGrand(){
let sum=0;
document.querySelectorAll(".cart-item").forEach(e=>{
const text=e.innerText.match(/[\d,]+ 원/);
if(text) sum+=parseInt(text[0].replace(/[^\d]/g,""));
});
document.getElementById("grandTotal").innerText=sum.toLocaleString();
}

/* PDF */
function downloadPDF(){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
doc.text("프로파일 견적서",20,20);
doc.text("총합: "+document.getElementById("grandTotal").innerText+" 원",20,40);
doc.save("견적서.pdf");
}

/* 견적 저장 + 메일 */
async function submitQuote(){
const items=[...document.querySelectorAll(".cart-item")].map(e=>e.innerText).join(" | ");
const total=document.getElementById("grandTotal").innerText;

await supabase.from("quotes").insert([{items,total,status:"접수"}]);

await fetch("/api/send-email",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({items,total})
});

alert("견적 접수 완료");
}

createSizeButtons();

</script>
</body>
</html>
