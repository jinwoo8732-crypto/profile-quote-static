<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>프로파일 자동견적</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6fb;}
.header{background:#1e2a45;color:#fff;padding:20px;text-align:center;font-size:20px;font-weight:bold;}
.section{background:#fff;padding:20px;margin-bottom:10px;}
.size-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;}
.size-card{padding:10px;background:#eef1f7;border-radius:10px;text-align:center;cursor:pointer;}
.size-card.active{background:#1e2a45;color:#fff;}
.size-card img{width:100%;max-height:80px;object-fit:contain;margin-bottom:6px;}
input,select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc;}
.error{color:red;font-size:13px;}
.cart-item{background:#f1f3f9;padding:10px;border-radius:8px;margin-bottom:8px;}
button{padding:8px;border:none;border-radius:6px;cursor:pointer;}
.btn-primary{background:#1e2a45;color:#fff;}
.btn-danger{background:#c0392b;color:#fff;}
.total{font-weight:bold;font-size:18px;margin-top:10px;}
</style>
</head>

<body>

<div class="header">프로파일 자동견적</div>

<div class="section">
<h3>1. 규격 선택</h3>
<div id="sizeGrid" class="size-grid"></div>
</div>

<div class="section">
<h3>2. 길이 / 수량</h3>
<select id="color" onchange="updateImage();updatePrice();">
<option value="silver">실버</option>
<option value="black">블랙</option>
</select>
<input type="number" id="length" placeholder="길이(mm)">
<div id="lengthError" class="error"></div>
<input type="number" id="qty" placeholder="수량">
<div class="total" id="price">0 원</div>
</div>

<div class="section">
<h3>3. 가공 옵션</h3>

<strong>한쪽 탭</strong><br>
<img src="images/tap_one.png" width="100"><br>
<input type="number" id="tapOneQty" value="0">

<br><br>

<strong>양쪽 탭</strong><br>
<img src="images/tap_two.png" width="100"><br>
<input type="number" id="tapTwoQty" value="0">

<br><br>

<strong>홀</strong><br>
<img src="images/hole.png" width="100"><br>
<input type="number" id="holeQty" value="0">

<br><br>

<strong>카운터보어</strong><br>
<img src="images/counter.png" width="100"><br>
<input type="number" id="counterQty" value="0">

<br><br>
<button class="btn-primary" onclick="addToCart()">장바구니 담기</button>
</div>

<div class="section">
<h3>장바구니</h3>
<div id="cartList"></div>
<div class="total">총 합계: <span id="grandTotal">0</span> 원</div>
<br>
<button onclick="downloadPDF()">PDF 다운로드</button>
<button class="btn-primary" onclick="submitQuote()">견적 요청</button>
</div>

<script>

const supabase = window.supabase.createClient(
"https://ritzqnjgivmrtysulzil.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpdHpxbmpnaXZtcnR5c3VsemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2MjMsImV4cCI6MjA4NzU1NjYyM30.oTeXacJlkMXKw1G4IRWUa3G2DM1wPvFl-9rzf5IdsxY"
);

const prices={
2020:{silver:3900,black:6000},
2040:{silver:6900,black:9000},
3030:{silver:8900,black:11000},
3060:{silver:14000,black:18000},
4040:{silver:16000,black:19000},
4080:{silver:28000,black:30000}
};

let selectedSize="2020";

function createSizeButtons(){
const grid=document.getElementById("sizeGrid");
Object.keys(prices).forEach(size=>{
const div=document.createElement("div");
div.className="size-card";
div.innerHTML=`<img id="img_${size}" src="images/${size}_silver.png"><div>${size}</div>`;
div.onclick=function(){
document.querySelectorAll(".size-card").forEach(c=>c.classList.remove("active"));
div.classList.add("active");
selectedSize=size;
updateImage();
updatePrice();
};
grid.appendChild(div);
});
document.querySelector(".size-card").classList.add("active");
}

function updateImage(){
const color=document.getElementById("color").value;
document.getElementById(`img_${selectedSize}`).src=`images/${selectedSize}_${color}.png`;
}

function calculate(){
const length=parseInt(document.getElementById("length").value)||0;
const qty=parseInt(document.getElementById("qty").value)||0;
const color=document.getElementById("color").value;
const tapOne=parseInt(document.getElementById("tapOneQty").value)||0;
const tapTwo=parseInt(document.getElementById("tapTwoQty").value)||0;
const hole=parseInt(document.getElementById("holeQty").value)||0;
const counter=parseInt(document.getElementById("counterQty").value)||0;

const error=document.getElementById("lengthError");
error.innerText="";

if(length<50){error.innerText="최소 50mm 이상 입력";return 0;}
if(length>3000){error.innerText="3m 초과 불가";return 0;}

const unit100=Math.ceil(length/100);
const base100=prices[selectedSize][color]/10;

let total=unit100*base100*qty;
total+=300*tapOne;
total+=600*tapTwo;
total+=400*hole;
total+=1000*counter;

return total;
}

function updatePrice(){
document.getElementById("price").innerText=calculate().toLocaleString()+" 원";
}

document.addEventListener("input",updatePrice);

function addToCart(){
const total=calculate();
if(total===0)return;

const div=document.createElement("div");
div.className="cart-item";
div.innerHTML=`
${selectedSize} / ${document.getElementById("color").value}<br>
길이 ${document.getElementById("length").value}mm / 수량 ${document.getElementById("qty").value}<br>
금액 <span class="linePrice">${total.toLocaleString()}</span> 원
<br><button class="btn-danger" onclick="this.parentElement.remove();updateGrand();">삭제</button>
`;
document.getElementById("cartList").appendChild(div);
updateGrand();
}

function updateGrand(){
let sum=0;
document.querySelectorAll(".linePrice").forEach(e=>{
sum+=parseInt(e.innerText.replace(/,/g,''))||0;
});
document.getElementById("grandTotal").innerText=sum.toLocaleString();
}

async function submitQuote(){
const total=document.getElementById("grandTotal").innerText;

await supabase.from("quotes").insert([{total,status:"접수"}]);

await fetch("/api/sendMail",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({total})
});

alert("견적 접수 완료");
}

function downloadPDF(){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
doc.text("프로파일 견적서",20,20);
doc.text("총 합계: "+document.getElementById("grandTotal").innerText+" 원",20,40);
doc.save("견적서.pdf");
}

createSizeButtons();
updatePrice();

</script>
</body>
</html>
