<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í”„ë¡œíŒŒì¼ ìë™ê²¬ì </title>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f6f7fb;}
.header{background:#1e2a45;color:#fff;padding:20px;text-align:center;font-size:20px;font-weight:bold;}
.section{background:#fff;padding:20px;margin-bottom:10px;}
.size-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;}
.size-card{padding:10px;background:#eef1f7;border-radius:10px;text-align:center;cursor:pointer;}
.size-card.active{background:#1e2a45;color:#fff;}
.size-card img{width:100%;max-height:80px;object-fit:contain;margin-bottom:6px;}
input,select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc;}
.total-box{font-weight:bold;font-size:18px;margin-top:10px;}
.cart-item{background:#f1f3f9;padding:10px;border-radius:8px;margin-bottom:8px;}
button{padding:8px 12px;margin-top:8px;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>

<body>

<div class="header">í”„ë¡œíŒŒì¼ ìë™ê²¬ì </div>

<div class="section">
<h3>1. ê·œê²© ì„ íƒ</h3>
<div id="sizeGrid" class="size-grid"></div>
</div>

<div class="section">
<h3>2. ê¸¸ì´ / ìˆ˜ëŸ‰</h3>

<select id="color">
<option value="silver">ì‹¤ë²„</option>
<option value="black">ë¸”ë™</option>
</select>

<input type="number" id="length" placeholder="ê¸¸ì´(mm)" min="50">
<input type="number" id="qty" placeholder="ìˆ˜ëŸ‰" min="1">

<div class="total-box" id="price">0 ì›</div>
</div>

<div class="section">
<h3>3. ê°€ê³µ ì˜µì…˜</h3>

í•œìª½íƒ­ <input type="number" id="tapOneQty" value="0">
ì–‘ìª½íƒ­ <input type="number" id="tapTwoQty" value="0">
í™€ <input type="number" id="holeQty" value="0">
ì¹´ìš´í„° <input type="number" id="counterQty" value="0">

<button onclick="addToCart()">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
</div>

<div class="section">
<h3>ì¥ë°”êµ¬ë‹ˆ</h3>
<div id="cartList"></div>
<div class="total-box">ì´ í•©ê³„: <span id="grandTotal">0</span> ì›</div>
<button onclick="downloadPDF()">PDF ë‹¤ìš´ë¡œë“œ</button>
<button onclick="submitQuote()">ê²¬ì  ìš”ì²­</button>
</div>

<script>

/* ğŸ” Supabase ë‹¨ í•œ ë²ˆë§Œ ì„ ì–¸ */
const supabase = window.supabase.createClient(
  "https://ritzqnjgivmrtysulzil.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpdHpxbmpnaXZtcnR5c3VsemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2MjMsImV4cCI6MjA4NzU1NjYyM30.oTeXacJlkMXKw1G4IRWUa3G2DM1wPvFl-9rzf5IdsxY"
);

/* ê°€ê²©í‘œ */
const prices={
2020:{silver:3900,black:6000},
2040:{silver:6900,black:9000},
3030:{silver:8900,black:11000},
3060:{silver:14000,black:18000}
};

let selectedSize="2020";

/* ê·œê²© ìƒì„± */
function createSizeButtons(){
const grid=document.getElementById("sizeGrid");
grid.innerHTML="";
Object.keys(prices).forEach(size=>{
const card=document.createElement("div");
card.className="size-card";
card.innerHTML=`
<img src="/images/${size}_silver.png">
<div>${size}</div>
`;
card.onclick=function(){
document.querySelectorAll(".size-card").forEach(c=>c.classList.remove("active"));
card.classList.add("active");
selectedSize=size;
updatePrice();
};
grid.appendChild(card);
});
document.querySelector(".size-card").classList.add("active");
}

/* ê³„ì‚° */
function calculateLine(size,color,length,qty,tapOne,tapTwo,hole,counter){
if(length<50||!qty) return 0;
const unit100=Math.ceil(length/100);
const base100=prices[size][color]/10;
let total=unit100*base100*qty;
total+=300*tapOne+600*tapTwo+400*hole+1000*counter;
return total;
}

function updatePrice(){
const color=document.getElementById("color").value;
const length=parseInt(document.getElementById("length").value)||0;
const qty=parseInt(document.getElementById("qty").value)||0;
const tapOne=parseInt(document.getElementById("tapOneQty").value)||0;
const tapTwo=parseInt(document.getElementById("tapTwoQty").value)||0;
const hole=parseInt(document.getElementById("holeQty").value)||0;
const counter=parseInt(document.getElementById("counterQty").value)||0;

const total=calculateLine(selectedSize,color,length,qty,tapOne,tapTwo,hole,counter);
document.getElementById("price").innerText=total.toLocaleString()+" ì›";
}

document.addEventListener("input",updatePrice);

/* ì¥ë°”êµ¬ë‹ˆ */
function addToCart(){
const color=document.getElementById("color").value;
const length=document.getElementById("length").value;
const qty=document.getElementById("qty").value;
if(!length||!qty){alert("ê¸¸ì´/ìˆ˜ëŸ‰ ì…ë ¥");return;}
const total=document.getElementById("price").innerText;

const div=document.createElement("div");
div.className="cart-item";
div.innerHTML=`
${selectedSize} (${color}) / ${length}mm / ${qty}ê°œ / ${total}
<br><button onclick="this.parentElement.remove();updateGrand();">ì‚­ì œ</button>
`;
document.getElementById("cartList").appendChild(div);
updateGrand();
}

function updateGrand(){
let sum=0;
document.querySelectorAll(".cart-item").forEach(e=>{
const match=e.innerText.match(/[\d,]+ ì›/);
if(match) sum+=parseInt(match[0].replace(/[^\d]/g,""));
});
document.getElementById("grandTotal").innerText=sum.toLocaleString();
}

/* PDF */
function downloadPDF(){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
doc.text("í”„ë¡œíŒŒì¼ ê²¬ì ì„œ",20,20);
doc.text("ì´í•©: "+document.getElementById("grandTotal").innerText+" ì›",20,40);
doc.save("ê²¬ì ì„œ.pdf");
}

/* DB ì €ì¥ + ë©”ì¼ */
async function submitQuote(){
const items=[...document.querySelectorAll(".cart-item")].map(e=>e.innerText).join(" | ");
const total=document.getElementById("grandTotal").innerText;

await supabase.from("quotes").insert([{items,total,status:"ì ‘ìˆ˜"}]);

await fetch("/api/send-email",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({items,total})
});

alert("ê²¬ì  ì ‘ìˆ˜ ì™„ë£Œ");
}

document.addEventListener("DOMContentLoaded",createSizeButtons);

</script>
</body>
</html>
