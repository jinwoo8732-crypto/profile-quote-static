<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>프로파일 자동견적</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6fa;margin:0;padding:20px;}
.container{max-width:1100px;margin:auto;background:#fff;padding:30px;border-radius:12px;}
.size-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;}
.size-btn{padding:10px;border:none;border-radius:8px;background:#e8ecf4;cursor:pointer;}
.size-btn.active{background:#2c3e70;color:#fff;}
input,select{padding:8px;margin:5px 0;border-radius:6px;border:1px solid #ccc;width:100%;}
button{padding:10px;border:none;border-radius:6px;background:#2c3e70;color:#fff;cursor:pointer;}
.cart table{width:100%;border-collapse:collapse;margin-top:15px;}
.cart th,.cart td{border:1px solid #ddd;padding:6px;text-align:center;}
.cart th{background:#f0f2f7;}
.total{text-align:right;font-weight:bold;margin-top:10px;}
</style>
</head>

<body>
<div class="container">

<h2>규격 선택</h2>
<div id="sizeGrid" class="size-grid"></div>

<h2>길이 및 수량</h2>
<select id="color">
<option value="silver">실버</option>
<option value="black">블랙</option>
</select>
<input type="number" id="length" placeholder="길이(mm)" min="50">
<input type="number" id="qty" placeholder="수량" min="1">
<div id="price">0 원</div>

<h2>가공 옵션</h2>
탭 <input type="number" id="tapQty" value="0">
홀 <input type="number" id="holeQty" value="0">
카운터 <input type="number" id="counterQty" value="0">
<br><br>
<button onclick="addToCart()">제품담기</button>

<div class="cart">
<h2>장바구니</h2>
<table>
<thead>
<tr>
<th>규격</th><th>색상</th><th>길이</th>
<th>수량</th><th>가공</th><th>금액</th><th>삭제</th>
</tr>
</thead>
<tbody id="cartBody"></tbody>
</table>
<div class="total">총 합계: <span id="grandTotal">0</span> 원</div>
</div>

<h2>고객 정보</h2>
<input type="text" id="custName" placeholder="고객명">
<input type="text" id="custPhone" placeholder="연락처">
<input type="email" id="custEmail" placeholder="이메일">
<br><br>
<button onclick="submitQuote()">견적 요청</button>

</div>

<script>

/* Supabase */
if (!window._sb) {
  window._sb = window.supabase.createClient(
    "https://ritzqnjgivmrtysulzil.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpdHpxbmpnaXZtcnR5c3VsemlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODA2MjMsImV4cCI6MjA4NzU1NjYyM30.oTeXacJlkMXKw1G4IRWUa3G2DM1wPvFl-9rzf5IdsxY"
  );
}

/* 단가표 */
const prices={
2020:{silver:3900,black:6000},
2040:{silver:6900,black:9000},
3030:{silver:8900,black:11000},
3060:{silver:14000,black:18000},
4040:{silver:16000,black:19000},
4080:{silver:28000,black:30000}
};

let selectedSize="2020";

/* 규격 버튼 */
function createSizeButtons(){
const grid=document.getElementById("sizeGrid");
Object.keys(prices).forEach(size=>{
const btn=document.createElement("button");
btn.innerText=size;
btn.className="size-btn";
btn.onclick=function(){
document.querySelectorAll(".size-btn").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
selectedSize=size;
updatePrice();
};
grid.appendChild(btn);
});
document.querySelector(".size-btn").classList.add("active");
}

/* 계산 */
function calculateLine(size,color,length,qty,tap,hole,counter){
if(length<50) length=50;
const unit100=Math.ceil(length/100);
const base100=prices[size][color]/10;
let total=unit100*base100*qty;
total+=300*tap+400*hole+1000*counter;
return {total,calculatedLength:unit100*100};
}

function updatePrice(){
const color=document.getElementById("color").value;
const length=parseInt(document.getElementById("length").value)||0;
const qty=parseInt(document.getElementById("qty").value)||0;
const tap=parseInt(document.getElementById("tapQty").value)||0;
const hole=parseInt(document.getElementById("holeQty").value)||0;
const counter=parseInt(document.getElementById("counterQty").value)||0;
const result=calculateLine(selectedSize,color,length,qty,tap,hole,counter);
document.getElementById("price").textContent=result.total.toLocaleString()+" 원";
}

document.addEventListener("input",updatePrice);

/* 장바구니 */
function addToCart(){
const color=document.getElementById("color").value;
const length=parseInt(document.getElementById("length").value)||0;
const qty=parseInt(document.getElementById("qty").value)||0;
const tap=parseInt(document.getElementById("tapQty").value)||0;
const hole=parseInt(document.getElementById("holeQty").value)||0;
const counter=parseInt(document.getElementById("counterQty").value)||0;
const result=calculateLine(selectedSize,color,length,qty,tap,hole,counter);

const row=document.createElement("tr");
row.innerHTML=`
<td>${selectedSize}</td>
<td>${color}</td>
<td>${result.calculatedLength}</td>
<td>${qty}</td>
<td>탭:${tap} 홀:${hole} 카운터:${counter}</td>
<td class="linePrice">${result.total.toLocaleString()}</td>
<td><button onclick="this.closest('tr').remove();updateGrand();">X</button></td>
`;
document.getElementById("cartBody").appendChild(row);
updateGrand();
}

function updateGrand(){
let sum=0;
document.querySelectorAll(".linePrice").forEach(cell=>{
sum+=parseInt(cell.textContent.replace(/,/g,''))||0;
});
document.getElementById("grandTotal").textContent=sum.toLocaleString();
}

/* PDF 생성 */
function generatePDF(orderNo,name,phone,email,items,total){

const { jsPDF } = window.jspdf;
const doc = new jsPDF();

doc.setFontSize(18);
doc.text("프로파일커머스 견적서",20,20);

doc.setFontSize(11);
doc.text("주문번호: "+orderNo,20,35);
doc.text("고객명: "+name,20,45);
doc.text("연락처: "+phone,20,55);
doc.text("이메일: "+email,20,65);

doc.text("--------------------------------------------------",20,75);

let y=85;
items.forEach((item,i)=>{
doc.text((i+1)+". "+item,20,y);
y+=8;
});

doc.text("--------------------------------------------------",20,y+5);

doc.setFontSize(14);
doc.text("총 합계: "+total.toLocaleString()+" 원",20,y+20);

doc.setFontSize(10);
doc.text("입금계좌: 국민은행 123-456-7890 (프로파일커머스)",20,y+35);
doc.text("견적 유효기간: 발행일로부터 7일",20,y+45);

doc.save("견적서_"+orderNo+".pdf");
}

/* 제출 */
async function submitQuote(){

const name=document.getElementById("custName").value;
const phone=document.getElementById("custPhone").value;
const email=document.getElementById("custEmail").value;
const total=parseInt(document.getElementById("grandTotal").textContent.replace(/,/g,''))||0;
const orderNo="BD-"+Date.now();

await window._sb.from("quotes").insert([{order_no:orderNo,name,phone,email,total,status:"접수"}]);

let items=[];
document.querySelectorAll("#cartBody tr").forEach(row=>{
items.push(row.innerText);
});

generatePDF(orderNo,name,phone,email,items,total);

alert("접수 완료! 주문번호: "+orderNo);
}

createSizeButtons();
updatePrice();

</script>
</body>
</html>
